name: Backend - Compile & Test

on: workflow_call

jobs:
  compile:
    name: Compile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: temurin

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-${{ hashFiles('**/build.properties') }}-${{ hashFiles('**/plugins.sbt') }}-${{ hashFiles('**/Dependencies.scala') }}
          path: |
            ~/.sbt
            ~/.cache/coursier
          restore-keys: |
            ${{ runner.os }}-${{ hashFiles('**/build.properties') }}-${{ hashFiles('**/plugins.sbt') }}
            ${{ runner.os }}-${{ hashFiles('**/build.properties') }}
            ${{ runner.os }}

      - name: Compile
        run: sbt compile "Test / compile"

  test:
    name: Test - ${{ matrix.module }}
    runs-on: ubuntu-latest
    needs: compile

    permissions:
      contents: read
      checks: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - module: migration-application
            sbt-project: migrationApplication
          - module: core
            sbt-project: core
          - module: api
            sbt-project: api
          - module: batch
            sbt-project: batch

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: temurin

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-${{ hashFiles('**/build.properties') }}-${{ hashFiles('**/plugins.sbt') }}-${{ hashFiles('**/Dependencies.scala') }}
          path: |
            ~/.sbt
            ~/.cache/coursier
          restore-keys: |
            ${{ runner.os }}-${{ hashFiles('**/build.properties') }}-${{ hashFiles('**/plugins.sbt') }}
            ${{ runner.os }}-${{ hashFiles('**/build.properties') }}
            ${{ runner.os }}

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install ffmpeg -y

      - name: Install yt-dlp
        run: pip install yt-dlp

      - name: Login to GitHub Container Registry
        run: docker login ghcr.io -u USERNAME -p ${{ secrets.GHCR_ACCESS_TOKEN }}

      - name: Run tests - ${{ matrix.module }}
        run: sbt "${{ matrix.sbt-project }} / test"

      - name: Upload test results
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: Test Results - ${{ matrix.module }}
          path: "${{ matrix.module }}/target/test-reports/*.xml"
          reporter: java-junit
